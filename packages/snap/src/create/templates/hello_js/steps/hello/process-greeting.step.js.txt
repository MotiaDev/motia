const { z } = require('zod');

const inputSchema = z.object({
  timestamp: z.string(),
  appName: z.string(),
  greetingPrefix: z.string(),
  requestId: z.string()
});

const config = {
  name: 'ProcessGreeting',
  type: 'event',
  description: 'Processes greeting in the background',
  subscribes: ['process-greeting'],
  emits: [],
  flows: ['hello-world-flow'],
  input: inputSchema
};

const handler = async (input, { logger, state }) => {
  const { timestamp, appName, greetingPrefix, requestId } = input;
  
  logger.info('Processing greeting', { requestId, appName });
  
  const greeting = `${greetingPrefix} ${appName}!`;

  await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate background processing

  // Store result in state (demonstrates state usage)
  // Note: The state.set method takes (groupId, key, value)
  await state.set('greetings', requestId, {
    greeting,
    processedAt: new Date().toISOString(),
    originalTimestamp: timestamp
  });

  logger.info('Greeting processed successfully', { 
    requestId, 
    greeting,
    storedInState: true 
  });
};

module.exports = { config, handler };
