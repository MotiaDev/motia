#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running lint-staged..."
npx lint-staged || exit 1

echo "ğŸ§¹ Running full lint..."
pnpm run lint || exit 1

echo "ğŸ§ª Detecting changed packages..."
CHANGED_PACKAGES=$(git diff --cached --name-only | grep "packages/" | cut -d'/' -f2 | sort -u)

if [ -z "$CHANGED_PACKAGES" ]; then
  echo "ğŸ§ª No changed packages detected. Skipping tests."
else
  for pkg in $CHANGED_PACKAGES; do
    echo "ğŸ§ª Running tests for @motiadev/$pkg..."
    pnpm --filter "@motiadev/$pkg" run test -- --bail --passWithNoTests || {
      echo "âŒ Tests failed in @motiadev/$pkg"
      exit 1
    }
  done
fi

echo "âœ… All checks passed. Proceeding with commit."
