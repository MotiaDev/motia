name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Version to rollback to (e.g., v0.1.0)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      delete_bad_release:
        description: 'Delete the problematic release'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  rollback:
    name: Rollback to ${{ github.event.inputs.target_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Validate target version
        id: validate
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
        run: |
          if [[ ! $TARGET_VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-alpha\.[0-9]+|-beta\.[0-9]+|-rc\.[0-9]+)?$ ]]; then
            echo "Error: Invalid version format. Use vX.Y.Z or vX.Y.Z-{alpha|beta|rc}.N (e.g., v0.1.0, v0.1.0-beta.1)"
            exit 1
          fi

          git fetch --tags
          if ! git rev-parse "$TARGET_VERSION" >/dev/null 2>&1; then
            echo "Error: Tag $TARGET_VERSION does not exist"
            exit 1
          fi

          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "Validated target version: $TARGET_VERSION"

      - name: Get current version
        id: current
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_TAG"

      - name: Notify Slack - Rollback Started
        id: slack_start
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "Rollback initiated"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Rollback Initiated*\n\nFrom: `${{ steps.current.outputs.current_tag }}`\nTo: `${{ github.event.inputs.target_version }}`\nReason: ${{ github.event.inputs.reason }}\nInitiated by: ${{ github.actor }}\n\n:hourglass: Processing rollback..."

      - name: Delete bad release
        if: github.event.inputs.delete_bad_release == 'true'
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          CURRENT_TAG: ${{ steps.current.outputs.current_tag }}
        run: |
          if [ "$CURRENT_TAG" != "none" ]; then
            echo "Deleting release $CURRENT_TAG"
            gh release delete "$CURRENT_TAG" --yes --cleanup-tag || echo "Release not found or already deleted"
          fi

      - name: Update version files to target version
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
        run: |
          VERSION_NUMBER="${TARGET_VERSION#v}"

          sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" motia-js/packages/motia/package.json
          rm motia-js/packages/motia/package.json.bak
          echo "Updated package.json to $VERSION_NUMBER"

          sed -i.bak "s/^version = \".*\"/version = \"$VERSION_NUMBER\"/" motia-py/packages/motia/pyproject.toml
          rm motia-py/packages/motia/pyproject.toml.bak
          echo "Updated pyproject.toml to $VERSION_NUMBER"

      - name: Commit rollback
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
          REASON: ${{ github.event.inputs.reason }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add motia-js/packages/motia/package.json motia-py/packages/motia/pyproject.toml
          git commit -m "chore: rollback to $TARGET_VERSION - $REASON"
          git push origin main

      - name: Create rollback tag
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
          REASON: ${{ github.event.inputs.reason }}
        run: |
          ROLLBACK_TAG="${TARGET_VERSION}-rollback"

          git tag -a "$ROLLBACK_TAG" -m "Rollback to $TARGET_VERSION: $REASON"
          git push origin "$ROLLBACK_TAG"

          echo "Created rollback tag: $ROLLBACK_TAG"

      - name: Update Slack - Rollback Complete
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.slack_start.outputs.ts }}
            text: "Rollback completed successfully"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Rollback Complete* :white_check_mark:\n\nFrom: `${{ steps.current.outputs.current_tag }}`\nTo: `${{ github.event.inputs.target_version }}`\nReason: ${{ github.event.inputs.reason }}\nInitiated by: ${{ github.actor }}"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/releases|View Releases>"

      - name: Update Slack - Rollback Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.slack_start.outputs.ts }}
            text: "Rollback failed"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Rollback Failed* :x:\n\nTarget version: `${{ github.event.inputs.target_version }}`\nReason: ${{ github.event.inputs.reason }}"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"

      - name: Summary
        if: always()
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
          REASON: ${{ github.event.inputs.reason }}
        run: |
          echo "### Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Version:** \`$TARGET_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** $REASON" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "Rollback completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "Rollback failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
