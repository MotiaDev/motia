name: Validate Release

on:
  workflow_run:
    workflows: ["Deploy Release"]
    types:
      - completed

env:
  GH_TOKEN: ${{ github.token }}

permissions:
  contents: write
  actions: read

jobs:
  validate:
    name: Validate Release Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get release tag
        id: get_tag
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # workflow_run.head_branch contains the tag name when deploy was triggered by tag push
          if [[ "$HEAD_BRANCH" =~ ^v[0-9] ]]; then
            TAG="$HEAD_BRANCH"
          else
            # Fallback to git describe if head_branch is not a tag
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi

          if [ -z "$TAG" ]; then
            echo "No tag found, skipping validation"
            exit 0
          fi

          VERSION="${TAG#v}"

          # Compute PEP 440 version for PyPI validation
          if [[ "$VERSION" =~ -alpha\.([0-9]+)$ ]]; then
            PYPI_VERSION="${VERSION%%-alpha.*}a${BASH_REMATCH[1]}"
          elif [[ "$VERSION" =~ -beta\.([0-9]+)$ ]]; then
            PYPI_VERSION="${VERSION%%-beta.*}b${BASH_REMATCH[1]}"
          elif [[ "$VERSION" =~ -rc\.([0-9]+)$ ]]; then
            PYPI_VERSION="${VERSION%%-rc.*}rc${BASH_REMATCH[1]}"
          else
            PYPI_VERSION="$VERSION"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pypi_version=$PYPI_VERSION" >> $GITHUB_OUTPUT
          echo "Validating release: $TAG (npm: $VERSION, PyPI: $PYPI_VERSION)"

      - name: Download Slack notification data
        id: download_slack
        continue-on-error: true
        run: |
          ARTIFACTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts")

          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name=="slack-notification-data") | .id')

          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "No slack-notification-data artifact found"
            exit 0
          fi

          mkdir -p slack-data
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" > artifact.zip

          unzip -q artifact.zip -d slack-data/

      - name: Get Slack message timestamp
        id: get_slack_ts
        run: |
          if [ -f "slack-data/message_ts.txt" ]; then
            SLACK_TS=$(cat slack-data/message_ts.txt)
            echo "slack_ts=$SLACK_TS" >> $GITHUB_OUTPUT
            echo "has_slack_ts=true" >> $GITHUB_OUTPUT
          else
            echo "has_slack_ts=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Node package on npm
        id: validate_node
        continue-on-error: true
        env:
          VERSION: ${{ steps.get_tag.outputs.version }}
        run: |
          if [ -z "$VERSION" ]; then exit 0; fi

          for i in 1 2 3 4 5; do
            if npm view "motia@$VERSION" version 2>/dev/null; then
              echo "node_ok=true" >> $GITHUB_OUTPUT
              echo "Node package motia@$VERSION found on npm"
              exit 0
            fi
            echo "Attempt $i: not yet available, waiting 30s..."
            sleep 30
          done

          echo "node_ok=false" >> $GITHUB_OUTPUT
          echo "Node package motia@$VERSION not found on npm after retries"

      - name: Validate Python package on PyPI
        id: validate_python
        continue-on-error: true
        env:
          PYPI_VERSION: ${{ steps.get_tag.outputs.pypi_version }}
        run: |
          if [ -z "$PYPI_VERSION" ]; then exit 0; fi

          for i in 1 2 3 4 5; do
            # Use PyPI JSON API directly for reliable version checking (handles PEP 440)
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/motia/$PYPI_VERSION/json")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "python_ok=true" >> $GITHUB_OUTPUT
              echo "Python package motia@$PYPI_VERSION found on PyPI"
              exit 0
            fi
            echo "Attempt $i: not yet available (HTTP $HTTP_STATUS), waiting 30s..."
            sleep 30
          done

          echo "python_ok=false" >> $GITHUB_OUTPUT
          echo "Python package motia@$PYPI_VERSION not found on PyPI after retries"

      - name: Update Slack - Validation Success
        if: >-
          (steps.validate_node.outputs.node_ok == 'true' || steps.validate_python.outputs.python_ok == 'true') &&
          steps.get_slack_ts.outputs.has_slack_ts == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.get_slack_ts.outputs.slack_ts }}
            text: "Release ${{ steps.get_tag.outputs.tag }} validated"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ steps.get_tag.outputs.tag }}* :white_check_mark:\n\n:${{ steps.validate_node.outputs.node_ok == 'true' && 'white_check_mark' || 'warning' }}: Node package on npm\n:${{ steps.validate_python.outputs.python_ok == 'true' && 'white_check_mark' || 'warning' }}: Python package on PyPI"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "View Release"
                    url: "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag }}"
                    style: "primary"

      - name: Update Slack - Validation Failed
        if: >-
          steps.validate_node.outputs.node_ok != 'true' &&
          steps.validate_python.outputs.python_ok != 'true' &&
          steps.get_slack_ts.outputs.has_slack_ts == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.get_slack_ts.outputs.slack_ts }}
            text: "Release ${{ steps.get_tag.outputs.tag }} validation failed"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ steps.get_tag.outputs.tag }}* :x:\n\nBoth npm and PyPI validation failed.\n\nAuto-rollback will be initiated."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"

      - name: Trigger auto-rollback
        if: >-
          steps.validate_node.outputs.node_ok != 'true' &&
          steps.validate_python.outputs.python_ok != 'true' &&
          steps.get_tag.outputs.tag != ''
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          PREVIOUS_TAG=$(git tag -l "v*" | sort -V | grep -F -x -B1 "${TAG}" | head -n1)

          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" == "$TAG" ]; then
            echo "No previous version found for rollback"
            exit 1
          fi

          gh workflow run rollback.yml \
            -f target_version="$PREVIOUS_TAG" \
            -f reason="Auto-rollback: Release validation failed - both npm and PyPI packages not found" \
            -f delete_bad_release=true

      - name: Summary
        if: always()
        env:
          TAG: ${{ steps.get_tag.outputs.tag }}
        run: |
          echo "### Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node package (npm) | ${{ steps.validate_node.outputs.node_ok == 'true' && 'OK' || 'NOT FOUND' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python package (PyPI) | ${{ steps.validate_python.outputs.python_ok == 'true' && 'OK' || 'NOT FOUND' }} |" >> $GITHUB_STEP_SUMMARY
