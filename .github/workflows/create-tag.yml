name: Create Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
          - prerelease-bump
      prerelease_identifier:
        description: 'Pre-release identifier (alpha, beta, rc) - only used with prerelease type'
        required: false
        type: choice
        options:
          - alpha
          - beta
          - rc
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          permissions: >-
            {
              "contents": "write",
              "metadata": "read"
            }

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get current version from git tags
        id: current_version
        run: |
          LATEST_TAG=$(git tag --sort=-version:refname --list 'v*' | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found, starting from v0.0.0"
            LATEST_TAG="v0.0.0"
          fi

          CURRENT="${LATEST_TAG#v}"
          echo "Current version: $CURRENT (tag: $LATEST_TAG)"
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compute next version
        id: next_version
        env:
          CURRENT: ${{ steps.current_version.outputs.version }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          PREID: ${{ github.event.inputs.prerelease_identifier }}
          CUSTOM: ${{ github.event.inputs.custom_version }}
        run: |
          if [[ -n "$CUSTOM" ]]; then
            if [[ ! $CUSTOM =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
              echo "::error::Invalid version format. Use semantic versioning (e.g., 1.2.3, v1.2.3, 1.2.3-beta.1)"
              exit 1
            fi
            NEW_VERSION=$(echo "$CUSTOM" | sed 's/^v//')
          else
            # Parse current version into components
            BASE=$(echo "$CURRENT" | cut -d'-' -f1)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"

            case "$VERSION_TYPE" in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
                ;;
              prerelease)
                # Create a new prepatch pre-release (e.g., 1.2.3 -> 1.2.4-beta.0)
                NEXT_PATCH=$((PATCH + 1))
                LABEL="${PREID:-beta}"
                NEW_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-${LABEL}.0"
                ;;
              prerelease-bump)
                # Bump existing pre-release number (e.g., 1.2.3-beta.0 -> 1.2.3-beta.1)
                PRE_PART=$(echo "$CURRENT" | cut -d'-' -f2-)
                if [ -z "$PRE_PART" ] || [ "$PRE_PART" = "$CURRENT" ]; then
                  echo "::error::Current version ($CURRENT) is not a pre-release. Use 'prerelease' instead."
                  exit 1
                fi

                # Extract pre-release label and number
                PRE_LABEL=$(echo "$PRE_PART" | sed 's/\.[0-9]*$//')
                PRE_NUM=$(echo "$PRE_PART" | grep -oE '[0-9]+$')

                if [ -z "$PRE_NUM" ]; then
                  PRE_NUM=0
                fi

                # Use provided preid or keep existing label
                if [ -n "$PREID" ]; then
                  PRE_LABEL="$PREID"
                fi

                NEW_VERSION="${BASE}-${PRE_LABEL}.$((PRE_NUM + 1))"
                ;;
              *)
                echo "::error::Unknown version type: $VERSION_TYPE"
                exit 1
                ;;
            esac
          fi

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          NEW_VERSION: ${{ steps.next_version.outputs.version }}
        run: |
          TAG_NAME="v${NEW_VERSION}"
          git tag -a "$TAG_NAME" -m "Release $NEW_VERSION"
          git push origin "$TAG_NAME"
          echo "Tag $TAG_NAME created and pushed successfully!"

      - name: Summary
        env:
          CURRENT_VERSION: ${{ steps.current_version.outputs.version }}
          NEW_VERSION: ${{ steps.next_version.outputs.version }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          PREID: ${{ github.event.inputs.prerelease_identifier }}
        run: |
          echo "### Tag Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous version:** ${CURRENT_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **New version:** ${NEW_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** v${NEW_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version type:** ${VERSION_TYPE}" >> $GITHUB_STEP_SUMMARY
          if [[ "${VERSION_TYPE}" =~ "prerelease" ]]; then
            echo "- **Pre-release identifier:** ${PREID}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deploy workflow will be triggered automatically by this tag." >> $GITHUB_STEP_SUMMARY
