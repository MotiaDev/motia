name: Create Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
          - prerelease-bump
      prerelease_identifier:
        description: 'Pre-release identifier (alpha, beta, rc) - only used with prerelease type'
        required: false
        type: choice
        options:
          - alpha
          - beta
          - rc
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          permissions: >-
            {
              "contents": "write",
              "metadata": "read"
            }

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create .npmrc
        run: |
          echo "tag-version-prefix=v" > .npmrc

      - name: Get current version
        id: current_version
        run: |
          current_version=$(node -p "require('./packages/motia/package.json').version")
          echo "Current version: v$current_version"
          echo "version=v$current_version" >> $GITHUB_OUTPUT

      - name: Build and execute version command
        id: version_command
        run: |
          version_type="${{ github.event.inputs.version_type }}"
          preid="${{ github.event.inputs.prerelease_identifier }}"
          custom="${{ github.event.inputs.custom_version }}"
          
          cmd="pnpm --workspace=@iii-dev/motia version"
          
          if [[ -n "$custom" ]]; then
            if [[ ! $custom =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
              echo "âŒ Invalid version format. Use semantic versioning (e.g., 1.2.3, v1.2.3, 1.2.3-beta.1)"
              exit 1
            fi
            custom_clean=$(echo "$custom" | sed 's/^v//')
            cmd="$cmd $custom_clean"
          elif [[ "$version_type" == "prerelease-bump" ]]; then
            cmd="$cmd prerelease"
          elif [[ "$version_type" == "prerelease" ]]; then
            cmd="$cmd prepatch"
          else
            cmd="$cmd $version_type"
          fi
                    
          if [[ "$version_type" == "prerelease" || "$version_type" == "prerelease-bump" ]] && [[ -n "$preid" ]]; then
            cmd="$cmd --preid $preid"
          fi
          
          cmd="$cmd --message 'Release v%s'"
          
          echo "Executing: $cmd"
          eval $cmd
          
          new_version=$(node -p "require('./packages/motia/package.json').version")
          echo "New version: v$new_version"
          echo "version=v$new_version" >> $GITHUB_OUTPUT

      - name: Show version information
        run: |
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New version:** ${{ steps.version_command.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version type:** ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event.inputs.version_type }}" =~ "prerelease" ]]; then
            echo "- **Pre-release identifier:** ${{ github.event.inputs.prerelease_identifier }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Push commit and tag
        run: |
          new_version="${{ steps.version_command.outputs.version }}"
          echo "ðŸ·ï¸ Pushing commit and tag: $new_version"
          
          git push --follow-tags
          
          commit_sha=$(git rev-parse HEAD)
          echo "âœ… Version $new_version created and pushed successfully!"
          echo "### âœ… Version Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $new_version" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** $commit_sha" >> $GITHUB_STEP_SUMMARY
          echo "- **View tag:** https://github.com/${{ github.repository }}/releases/tag/$new_version" >> $GITHUB_STEP_SUMMARY
          
          echo "commit=$commit_sha" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

      - name: Set outputs
        id: outputs
        run: |
          echo "tag=${{ steps.version_command.outputs.version }}" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT 