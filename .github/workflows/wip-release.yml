name: WIP Release

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'NPM distribution tag (e.g. beta, alpha, next)'
        required: true
        default: 'next'
      branch:
        description: 'Branch containing the WIP changes (you can specify any branch name)'
        required: true
        default: 'main'

jobs:
  wip-release:
    runs-on: ubuntu-latest
    steps:
      - name: Warning
        run: |
          echo "⚠️  WARNING: WIP Release bypasses the approval gate"
          echo "This workflow should only be used for testing purposes"
          echo "For production releases, use the Create Tag workflow instead"
          echo ""
          echo "Publishing to NPM tag: ${{ github.event.inputs.tag }}"
          echo "From branch: ${{ github.event.inputs.branch }}"

      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get current version
        id: current_version
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "Current version: $current_version"
          echo "version=$current_version" >> $GITHUB_OUTPUT

      - name: Bump version with timestamp
        id: version
        run: |
          tag="${{ github.event.inputs.tag }}"
          current_version=$(node -p "require('./package.json').version")
          
          base_version=$(echo $current_version | cut -d'-' -f1)
          
          IFS='.' read -r major minor patch <<< "$base_version"
          next_patch=$((patch + 1))
          
          timestamp=$(date +%Y%m%d%H%M%S)
          new_version="${major}.${minor}.${next_patch}-${tag}.${timestamp}"
          
          echo "Setting version to: $new_version"
          pnpm version $new_version --no-git-tag-version
          
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Show version information
        run: |
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM distribution tag:** ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY

      - name: Sync version to motia package
        run: |
          new_version=$(node -p "require('./package.json').version")
          cd packages/motia
          pnpm version $new_version --no-git-tag-version

      - name: Setup NPM authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc

      - name: Publish packages with custom tag
        run: |
          pnpm publish -r --filter @iii-dev/motia --no-git-checks --tag ${{ github.event.inputs.tag }}

