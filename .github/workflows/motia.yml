name: Motia CI

permissions:
  contents: read

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'contributors/**'

  push:
    branches:
      - main
    tags:
      - 'v*' # Match tags that start with "v"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
      - name: Setup
        uses: ./.github/actions/setup
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}

      - name: Run linter
        run: pnpm lint:ci

      - name: Run tests
        run: pnpm test:ci

  quality-on-tags:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
    needs: [quality]
    steps:
      - name: Quality check passed for tag
        run: |
          echo "âœ… Quality checks passed for tag ${{ github.ref }}"
          echo "ðŸš€ Deploy workflow will handle the release process"
